import{d as _e,r as v,u as be,c as N,E as De,af as ke,ag as we,C as _,b as w,w as o,e as l,o as i,g as n,I as K,h as R,i as Q,j as d,z as X,x as m,G as I,ah as Ie,ai as Pe,l as c,aj as Se,v as g,ak as Ce,k as Y,n as p,al as Me,P as B,Q as z,am as Z,p as ee,X as ae,a9 as Ve,q as he,s as x,a3 as Le,ad as $e,ae as Ne,a0 as xe,K as te,L as O,a7 as Te,a8 as le,t as Ee,y as Re}from"./index-yNZZBFxb.js";import{_ as Be}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ze={class:"week-navigation"},Oe={class:"week-label"},Fe={class:"day-header"},Ae={class:"date-label"},Ue={key:0},We={key:1},je={key:1,class:"empty-day"},Ge={key:0},qe={key:1},He={key:0},Je={key:1,class:"ion-padding ion-text-center"},Ke={key:1},Qe={class:"ion-padding"},Xe=_e({__name:"MealPlannerPage",setup(Ye){const F=v([]),C=v(!1),P=v(""),f=v("recipe"),T=v([]),y=v(null),S=v(new Date),M=v(!1),h=v("");let L=null;const u=v({type:"lunch",recipe_id:null,description:""}),$=be(),ne=N(()=>{var a;return f.value==="recipe"?!!u.value.recipe_id:!!((a=u.value.description)!=null&&a.trim())});function A(a){const e=a.getFullYear(),t=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return"".concat(e,"-").concat(t,"-").concat(s)}function U(){return A(new Date)}function E(a){const e=U();return a<e}const V=N(()=>{const a=[],e=new Date(S.value);e.setHours(0,0,0,0);const t=new Date(e);t.setDate(e.getDate()-e.getDay()+(e.getDay()===0?-6:1));const s=U();for(let r=0;r<7;r++){const D=new Date(t);D.setDate(t.getDate()+r);const k=A(D),ge=k===s,ye=E(k);a.push({date:k,dayName:H(D),dateLabel:J(D),isToday:ge,isPast:ye})}return a}),oe=N(()=>{var t,s;const a=((t=V.value[0])==null?void 0:t.dateLabel)||"",e=((s=V.value[6])==null?void 0:s.dateLabel)||"";return"".concat(a," - ").concat(e)}),se=N(()=>{if(!P.value)return"";const a=new Date(P.value+"T00:00:00");return"".concat(H(a)," ").concat(J(a))});De(()=>{G(),re(),ie()}),ke(()=>{W()}),we(()=>{W()});async function b(){var a,e,t;try{const s=(a=_.authStore.model)==null?void 0:a.id;if(!s)return;const r=(e=V.value[0])==null?void 0:e.date,D=(t=V.value[6])==null?void 0:t.date;console.log("Loading meals for week:",r,"to",D);const k=await _.collection("meal_plans").getFullList({filter:'user = "'.concat(s,'" && date >= "').concat(r,'" && date <= "').concat(D,'"'),expand:"recipe",sort:"date,type"});console.log("Loaded",k.length,"meals:",k),F.value=k}catch(s){console.error(s)}}async function ie(){var a;try{const e=(a=_.authStore.model)==null?void 0:a.id;if(!e)return;L=await _.collection("meal_plans").subscribe("*",t=>{console.log("Realtime event:",t.action),t.record.user===e&&(t.action==="create"?(h.value="âœ… Nuevo plan aÃ±adido",M.value=!0):t.action==="update"?(h.value="âœï¸ Plan actualizado",M.value=!0):t.action==="delete"&&(h.value="ðŸ—‘ï¸ Plan eliminado",M.value=!0),b())})}catch(e){console.error("Error subscribing to realtime:",e)}}function W(){L&&(L(),L=null)}async function re(){$.myRecipes.length===0&&await $.fetchProfile();const a=[...$.myRecipes||[],...$.savedRecipes||[]];T.value=a}function j(a){return F.value.filter(e=>e.date===a)}function G(){S.value=new Date,b()}function ue(){const a=new Date(S.value);a.setDate(a.getDate()-7),S.value=a,b()}function de(){const a=new Date(S.value);a.setDate(a.getDate()+7),S.value=a,b()}function ce(a){if(E(a)){alert("âš ï¸ No puedes crear planes para dÃ­as pasados");return}y.value=null,P.value=a,u.value={type:"lunch",recipe_id:null,description:""},f.value="recipe",C.value=!0}function pe(a,e){if(e){alert("âš ï¸ No puedes editar planes de dÃ­as pasados");return}y.value=a,P.value=a.date,u.value={type:a.type,recipe_id:a.recipe||null,description:a.description||""},f.value=a.recipe?"recipe":"manual",C.value=!0}function q(){C.value=!1,y.value=null}async function fe(){var a,e,t;try{const s=(a=_.authStore.model)==null?void 0:a.id;if(!s){alert("Debes iniciar sesiÃ³n");return}if(E(P.value)){alert("âš ï¸ No puedes crear o editar planes para dÃ­as pasados");return}if(f.value==="recipe"&&!u.value.recipe_id){alert("Por favor, selecciona una receta");return}if(f.value==="manual"&&!((e=u.value.description)!=null&&e.trim())){alert("Por favor, escribe una descripciÃ³n");return}const r={user:s,date:P.value,type:u.value.type,recipe:f.value==="recipe"?u.value.recipe_id:null,description:f.value==="manual"?u.value.description:null};y.value?await _.collection("meal_plans").update(y.value.id,r):await _.collection("meal_plans").create(r),C.value=!1,y.value=null,await b()}catch(s){console.error("Error completo:",s);const r=((t=s.data)==null?void 0:t.message)||s.message||"Error desconocido";alert("Error al guardar: ".concat(r))}}async function ve(a,e){if(e){alert("âš ï¸ No puedes eliminar planes de dÃ­as pasados");return}if(confirm("Â¿Borrar plan de comida?"))try{await _.collection("meal_plans").delete(a),await b()}catch(t){alert("Error al borrar")}}function H(a){return["Domingo","Lunes","Martes","MiÃ©rcoles","Jueves","Viernes","SÃ¡bado"][a.getDay()]}function J(a){const e=a.getDate(),t=a.getMonth()+1;return"".concat(e,"/").concat(t)}function me(a){return a==="lunch"?"Comida":"Cena"}return(a,e)=>(i(),w(l(Re),null,{default:o(()=>[n(l(K),null,{default:o(()=>[n(l(R),null,{default:o(()=>[n(l(Q),null,{default:o(()=>[...e[5]||(e[5]=[d("MenÃº Semanal",-1)])]),_:1}),n(l(X),{slot:"end"},{default:o(()=>[n(l(m),{onClick:G},{default:o(()=>[n(l(I),{icon:l(Ie),slot:"icon-only"},null,8,["icon"])]),_:1}),n(l(m),{onClick:b},{default:o(()=>[n(l(I),{icon:l(Pe),slot:"icon-only"},null,8,["icon"])]),_:1})]),_:1})]),_:1}),n(l(R),null,{default:o(()=>[c("div",ze,[n(l(m),{fill:"clear",onClick:ue},{default:o(()=>[n(l(I),{icon:l(Se)},null,8,["icon"])]),_:1}),c("span",Oe,g(oe.value),1),n(l(m),{fill:"clear",onClick:de},{default:o(()=>[n(l(I),{icon:l(Ce)},null,8,["icon"])]),_:1})])]),_:1})]),_:1}),n(l(Y),{class:"ion-padding"},{default:o(()=>[n(l(Me),{"is-open":M.value,message:h.value,duration:3e3,position:"top",color:"success",onDidDismiss:e[0]||(e[0]=t=>M.value=!1)},null,8,["is-open","message"]),(i(!0),p(B,null,z(V.value,t=>(i(),p("div",{key:t.date,class:Z(["day-section",{today:t.isToday,past:t.isPast}])},[c("div",Fe,[c("div",null,[c("h2",null,g(t.dayName),1),c("small",Ae,[d(g(t.dateLabel)+" ",1),t.isToday?(i(),w(l(ae),{key:0,color:"success",class:"today-badge"},{default:o(()=>[...e[6]||(e[6]=[d("Hoy",-1)])]),_:1})):ee("",!0),t.isPast?(i(),w(l(ae),{key:1,color:"medium",class:"past-badge"},{default:o(()=>[...e[7]||(e[7]=[d("Pasado",-1)])]),_:1})):ee("",!0)])]),n(l(m),{fill:"clear",size:"small",onClick:s=>ce(t.date),disabled:t.isPast,title:t.isPast?"No puedes aÃ±adir planes a dÃ­as pasados":"AÃ±adir plan"},{default:o(()=>[n(l(I),{icon:l(Ve),slot:"icon-only"},null,8,["icon"])]),_:1},8,["onClick","disabled","title"])]),j(t.date).length?(i(),w(l(he),{key:0,lines:"none"},{default:o(()=>[(i(!0),p(B,null,z(j(t.date),s=>(i(),w(l(x),{key:s.id,class:Z(["meal-item",{"past-meal":t.isPast}])},{default:o(()=>[n(l(Le),{class:"ion-text-wrap"},{default:o(()=>{var r;return[c("h3",null,g(me(s.type)),1),(r=s.expand)!=null&&r.recipe?(i(),p("p",Ue,"ðŸ½ï¸ "+g(s.expand.recipe.title),1)):(i(),p("p",We,"ðŸ“ "+g(s.description),1))]}),_:2},1024),n(l(m),{fill:"clear",color:"primary",slot:"end",onClick:r=>pe(s,t.isPast),disabled:t.isPast,title:t.isPast?"No puedes editar planes pasados":"Editar"},{default:o(()=>[n(l(I),{icon:l($e),slot:"icon-only"},null,8,["icon"])]),_:1},8,["onClick","disabled","title"]),n(l(m),{fill:"clear",color:"danger",slot:"end",onClick:r=>ve(s.id,t.isPast),disabled:t.isPast,title:t.isPast?"No puedes borrar planes pasados":"Borrar"},{default:o(()=>[n(l(I),{icon:l(Ne),slot:"icon-only"},null,8,["icon"])]),_:1},8,["onClick","disabled","title"])]),_:2},1032,["class"]))),128))]),_:2},1024)):(i(),p("div",je,[t.isPast?(i(),p("small",Ge,"DÃ­a pasado - Sin registro")):(i(),p("small",qe,"Sin planes"))]))],2))),128)),n(l(xe),{"is-open":C.value,onDidDismiss:q},{default:o(()=>[n(l(K),null,{default:o(()=>[n(l(R),null,{default:o(()=>[n(l(Q),null,{default:o(()=>[d(g(y.value?"Editar":"AÃ±adir")+" - "+g(se.value),1)]),_:1}),n(l(X),{slot:"end"},{default:o(()=>[n(l(m),{onClick:q},{default:o(()=>[...e[8]||(e[8]=[d("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),n(l(Y),{class:"ion-padding"},{default:o(()=>[n(l(x),null,{default:o(()=>[n(l(te),{label:"Tipo",modelValue:u.value.type,"onUpdate:modelValue":e[1]||(e[1]=t=>u.value.type=t),interface:"popover"},{default:o(()=>[n(l(O),{value:"lunch"},{default:o(()=>[...e[9]||(e[9]=[d("Comida",-1)])]),_:1}),n(l(O),{value:"dinner"},{default:o(()=>[...e[10]||(e[10]=[d("Cena",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),e[15]||(e[15]=c("div",{class:"info-box ion-margin-vertical"},[c("p",null,[c("strong",null,"ðŸ½ï¸ Receta Guardada:"),d(" Vincula una receta que ya tienes")]),c("p",null,[c("strong",null,"ðŸ“ Manual:"),d(' Escribe texto libre (ej: "Pizza fuera")')])],-1)),n(l(Te),{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=t=>f.value=t),class:"ion-margin-vertical"},{default:o(()=>[n(l(le),{value:"recipe"},{default:o(()=>[...e[11]||(e[11]=[d("Receta Guardada",-1)])]),_:1}),n(l(le),{value:"manual"},{default:o(()=>[...e[12]||(e[12]=[d("Manual",-1)])]),_:1})]),_:1},8,["modelValue"]),f.value==="recipe"?(i(),p("div",He,[T.value.length?(i(),w(l(x),{key:0},{default:o(()=>[n(l(te),{label:"Elige Receta",modelValue:u.value.recipe_id,"onUpdate:modelValue":e[3]||(e[3]=t=>u.value.recipe_id=t),placeholder:"Selecciona una receta",interface:"alert"},{default:o(()=>[(i(!0),p(B,null,z(T.value,t=>(i(),w(l(O),{key:t.id,value:t.id},{default:o(()=>[d(g(t.title),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):(i(),p("div",Je,[e[14]||(e[14]=c("p",null,"No tienes recetas.",-1)),n(l(m),{size:"small","router-link":"/recipes/new"},{default:o(()=>[...e[13]||(e[13]=[d("Crear Receta",-1)])]),_:1})]))])):(i(),p("div",Ke,[n(l(x),null,{default:o(()=>[n(l(Ee),{label:"DescripciÃ³n","label-placement":"floating",modelValue:u.value.description,"onUpdate:modelValue":e[4]||(e[4]=t=>u.value.description=t),placeholder:"Ej: Pizza fuera, Sobras, Restaurante...",required:""},null,8,["modelValue"])]),_:1})])),c("div",Qe,[n(l(m),{expand:"block",onClick:fe,disabled:!ne.value},{default:o(()=>[d(g(y.value?"Actualizar":"Guardar"),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["is-open"])]),_:1})]),_:1}))}}),aa=Be(Xe,[["__scopeId","data-v-5dfc6b52"]]);export{aa as default};
